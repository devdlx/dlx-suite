function WebTorrent(e){function r(){t.destroyed||(t.ready=!0,t.emit("ready"))}var t=this;return t instanceof WebTorrent?(EventEmitter.call(t),e||(e={}),"string"==typeof e.peerId?t.peerId=e.peerId:Buffer.isBuffer(e.peerId)?t.peerId=e.peerId.toString("hex"):t.peerId=Buffer.from(VERSION_PREFIX+hat(48)),t.peerIdBuffer=Buffer.from(t.peerId,"hex"),"string"==typeof e.nodeId?t.nodeId=e.nodeId:Buffer.isBuffer(e.nodeId)?t.nodeId=e.nodeId.toString("hex"):t.nodeId=hat(160),t.nodeIdBuffer=Buffer.from(t.nodeId,"hex"),t.destroyed=!1,t.listening=!1,t.torrentPort=e.torrentPort||0,t.dhtPort=e.dhtPort||0,t.tracker=void 0!==e.tracker?e.tracker:{},t.torrents=[],t.maxConns=Number(e.maxConns)||55,t.tracker&&("object"!=typeof t.tracker&&(t.tracker={}),e.rtcConfig&&(console.warn("WebTorrent: opts.rtcConfig is deprecated. Use opts.tracker.rtcConfig instead"),t.tracker.rtcConfig=e.rtcConfig),e.wrtc&&(console.warn("WebTorrent: opts.wrtc is deprecated. Use opts.tracker.wrtc instead"),t.tracker.wrtc=e.wrtc),global.WRTC&&!t.tracker.wrtc&&(t.tracker.wrtc=global.WRTC)),"function"==typeof TCPPool?t._tcpPool=new TCPPool(t):process.nextTick(function(){t._onListening()}),t._downloadSpeed=speedometer(),t._uploadSpeed=speedometer(),e.dht!==!1&&"function"==typeof DHT?(t.dht=new DHT(extend({nodeId:t.nodeId},e.dht)),t.dht.once("error",function(e){t._destroy(e)}),t.dht.once("listening",function(){var e=t.dht.address();e&&(t.dhtPort=e.port)}),t.dht.setMaxListeners(0),t.dht.listen(t.dhtPort)):t.dht=!1,debug("new webtorrent (peerId %s, nodeId %s)",t.peerId,t.nodeId),void("function"==typeof loadIPSet?loadIPSet(e.blocklist,{headers:{"user-agent":"WebTorrent/"+VERSION+" (https://webtorrent.io)"}},function(e,o){return e?t.error("Failed to load blocklist: "+e.message):(t.blocked=o,void r())}):process.nextTick(r))):new WebTorrent(e)}function isReadable(e){return"object"==typeof e&&null!=e&&"function"==typeof e.pipe}module.exports=WebTorrent;var Buffer=require("safe-buffer").Buffer,concat=require("simple-concat"),createTorrent=require("create-torrent"),debug=require("debug")("webtorrent"),DHT=require("bittorrent-dht/client"),EventEmitter=require("events").EventEmitter,extend=require("xtend"),hat=require("hat"),inherits=require("inherits"),loadIPSet=require("load-ip-set"),parallel=require("run-parallel"),parseTorrent=require("parse-torrent"),path=require("path"),Peer=require("simple-peer"),speedometer=require("speedometer"),zeroFill=require("zero-fill"),TCPPool=require("./lib/tcp-pool"),Torrent=require("./lib/torrent"),VERSION=require("./package.json").version,VERSION_STR=VERSION.match(/([0-9]+)/g).slice(0,2).map(zeroFill(2)).join(""),VERSION_PREFIX="-WW"+VERSION_STR+"-";inherits(WebTorrent,EventEmitter),WebTorrent.WEBRTC_SUPPORT=Peer.WEBRTC_SUPPORT,Object.defineProperty(WebTorrent.prototype,"downloadSpeed",{get:function(){return this._downloadSpeed()}}),Object.defineProperty(WebTorrent.prototype,"uploadSpeed",{get:function(){return this._uploadSpeed()}}),Object.defineProperty(WebTorrent.prototype,"progress",{get:function(){var e=this.torrents.filter(function(e){return 1!==e.progress}),r=e.reduce(function(e,r){return e+r.downloaded},0),t=e.reduce(function(e,r){return e+(r.length||0)},0)||1;return r/t}}),Object.defineProperty(WebTorrent.prototype,"ratio",{get:function(){var e=this.torrents.reduce(function(e,r){return e+r.uploaded},0),r=this.torrents.reduce(function(e,r){return e+r.received},0)||1;return e/r}}),WebTorrent.prototype.get=function(e){var r,t,o=this,n=o.torrents.length;if(e instanceof Torrent){for(r=0;r<n;r++)if(t=o.torrents[r],t===e)return t}else{var i;try{i=parseTorrent(e)}catch(e){}if(!i)return null;if(!i.infoHash)throw new Error("Invalid torrent identifier");for(r=0;r<n;r++)if(t=o.torrents[r],t.infoHash===i.infoHash)return t}return null},WebTorrent.prototype.download=function(e,r,t){return console.warn("WebTorrent: client.download() is deprecated. Use client.add() instead"),this.add(e,r,t)},WebTorrent.prototype.add=function(e,r,t){function o(){if(!d.destroyed)for(var e=0,r=d.torrents.length;e<r;e++){var t=d.torrents[e];if(t.infoHash===s.infoHash&&t!==s)return void s._destroy(new Error("Cannot add duplicate torrent "+s.infoHash))}}function n(){d.destroyed||("function"==typeof t&&t(s),d.emit("torrent",s))}function i(){s.removeListener("_infoHash",o),s.removeListener("ready",n),s.removeListener("close",i)}var d=this;if(d.destroyed)throw new Error("client is destroyed");if("function"==typeof r)return d.add(e,null,r);debug("add"),r=r?extend(r):{};var s=new Torrent(e,d,r);return d.torrents.push(s),s.once("_infoHash",o),s.once("ready",n),s.once("close",i),s},WebTorrent.prototype.seed=function(e,r,t){function o(e){var r=[function(r){e.load(d,r)}];i.dht&&r.push(function(r){e.once("dhtAnnounce",r)}),parallel(r,function(r){if(!i.destroyed)return r?e._destroy(r):void n(e)})}function n(e){debug("on seed"),"function"==typeof t&&t(e),e.emit("seed"),i.emit("seed",e)}var i=this;if(i.destroyed)throw new Error("client is destroyed");if("function"==typeof r)return i.seed(e,null,r);debug("seed"),r=r?extend(r):{},"string"==typeof e&&(r.path=path.dirname(e)),r.createdBy||(r.createdBy="WebTorrent/"+VERSION_STR),i.tracker||(r.announce=[]);var d,s=i.add(null,r,o);return Array.isArray(e)||(e=[e]),parallel(e.map(function(e){return function(r){isReadable(e)?concat(e,r):r(null,e)}}),function(e,t){if(!i.destroyed)return e?s._destroy(e):void createTorrent.parseInput(t,r,function(e,o){if(!i.destroyed){if(e)return s._destroy(e);d=o.map(function(e){return e.getStream}),createTorrent(t,r,function(e,r){if(!i.destroyed){if(e)return s._destroy(e);var t=i.get(r);t?s._destroy(new Error("Cannot add duplicate torrent "+t.infoHash)):s._onTorrentId(r)}})}})}),s},WebTorrent.prototype.remove=function(e,r){debug("remove");var t=this.get(e);if(!t)throw new Error("No torrent with id "+e);this._remove(e,r)},WebTorrent.prototype._remove=function(e,r){var t=this.get(e);t&&(this.torrents.splice(this.torrents.indexOf(t),1),t.destroy(r))},WebTorrent.prototype.address=function(){return this.listening?this._tcpPool?this._tcpPool.server.address():{address:"0.0.0.0",family:"IPv4",port:0}:null},WebTorrent.prototype.destroy=function(e){if(this.destroyed)throw new Error("client already destroyed");this._destroy(null,e)},WebTorrent.prototype._destroy=function(e,r){var t=this;debug("client destroy"),t.destroyed=!0;var o=t.torrents.map(function(e){return function(r){e.destroy(r)}});t._tcpPool&&o.push(function(e){t._tcpPool.destroy(e)}),t.dht&&o.push(function(e){t.dht.destroy(e)}),parallel(o,r),e&&t.emit("error",e),t.torrents=[],t._tcpPool=null,t.dht=null},WebTorrent.prototype._onListening=function(){if(this.listening=!0,this._tcpPool){var e=this._tcpPool.server.address();e&&(this.torrentPort=e.port)}this.emit("listening")};