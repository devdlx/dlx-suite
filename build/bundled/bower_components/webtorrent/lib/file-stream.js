function FileStream(e,t){stream.Readable.call(this,t),this.destroyed=!1,this._torrent=e._torrent;var i=t&&t.start||0,r=t&&t.end&&t.end<e.length?t.end:e.length-1,s=e._torrent.pieceLength;this._startPiece=(i+e.offset)/s|0,this._endPiece=(r+e.offset)/s|0,this._piece=this._startPiece,this._offset=i+e.offset-this._startPiece*s,this._missing=r-i+1,this._reading=!1,this._notifying=!1,this._criticalLength=Math.min(1048576/s|0,2)}module.exports=FileStream;var debug=require("debug")("webtorrent:file-stream"),inherits=require("inherits"),stream=require("readable-stream");inherits(FileStream,stream.Readable),FileStream.prototype._read=function(){this._reading||(this._reading=!0,this._notify())},FileStream.prototype._notify=function(){var e=this;if(e._reading&&0!==e._missing){if(!e._torrent.bitfield.get(e._piece))return e._torrent.critical(e._piece,e._piece+e._criticalLength);if(!e._notifying){e._notifying=!0;var t=e._piece;e._torrent.store.get(t,function(i,r){if(e._notifying=!1,!e.destroyed){if(i)return e._destroy(i);debug("read %s (length %s) (err %s)",t,r.length,i&&i.message),e._offset&&(r=r.slice(e._offset),e._offset=0),e._missing<r.length&&(r=r.slice(0,e._missing)),e._missing-=r.length,debug("pushing buffer of length %s",r.length),e._reading=!1,e.push(r),0===e._missing&&e.push(null)}}),e._piece+=1}}},FileStream.prototype.destroy=function(e){this._destroy(null,e)},FileStream.prototype._destroy=function(e,t){this.destroyed||(this.destroyed=!0,this._torrent.destroyed||this._torrent.deselect(this._startPiece,this._endPiece,!0),e&&this.emit("error",e),this.emit("close"),t&&t())};