function WebConn(e,t){Wire.call(this),this.url=e,this.webPeerId=sha1.sync(e),this._torrent=t,this._init()}module.exports=WebConn;var BitField=require("bitfield"),Buffer=require("safe-buffer").Buffer,debug=require("debug")("webtorrent:webconn"),get=require("simple-get"),inherits=require("inherits"),sha1=require("simple-sha1"),Wire=require("bittorrent-protocol"),VERSION=require("../package.json").version;inherits(WebConn,Wire),WebConn.prototype._init=function(){var e=this;e.setKeepAlive(!0),e.once("handshake",function(t,n){if(!e.destroyed){e.handshake(t,e.webPeerId);for(var r=e._torrent.pieces.length,o=new BitField(r),i=0;i<=r;i++)o.set(i,!0);e.bitfield(o)}}),e.once("interested",function(){debug("interested"),e.unchoke()}),e.on("uninterested",function(){debug("uninterested")}),e.on("choke",function(){debug("choke")}),e.on("unchoke",function(){debug("unchoke")}),e.on("bitfield",function(){debug("bitfield")}),e.on("request",function(t,n,r,o){debug("request pieceIndex=%d offset=%d length=%d",t,n,r),e.httpRequest(t,n,r,o)})},WebConn.prototype.httpRequest=function(e,t,n,r){var o,i=this,u=e*i._torrent.pieceLength,s=u+t,f=s+n-1,d=i._torrent.files;if(d.length<=1)o=[{url:i.url,start:s,end:f}];else{var l=d.filter(function(e){return e.offset<=f&&e.offset+e.length>s});if(l.length<1)return r(new Error("Could not find file corresponnding to web seed range request"));o=l.map(function(e){var t=e.offset+e.length-1,n=i.url+("/"===i.url[i.url.length-1]?"":"/")+e.path;return{url:n,fileOffsetInRange:Math.max(e.offset-s,0),start:Math.max(s-e.offset,0),end:Math.min(t,f-e.offset)}})}var h,a=0,c=!1;o.length>1&&(h=Buffer.alloc(n)),o.forEach(function(i){var u=i.url,s=i.start,f=i.end;debug("Requesting url=%s pieceIndex=%d offset=%d length=%d start=%d end=%d",u,e,t,n,s,f);var d={url:u,method:"GET",headers:{"user-agent":"WebTorrent/"+VERSION+" (https://webtorrent.io)",range:"bytes="+s+"-"+f}};get.concat(d,function(e,t,n){if(!c){if(e)return c=!0,r(e);if(t.statusCode<200||t.statusCode>=300)return c=!0,r(new Error("Unexpected HTTP status code "+t.statusCode));debug("Got data of length %d",n.length),1===o.length?r(null,n):(n.copy(h,i.fileOffsetInRange),++a===o.length&&r(null,h))}})})},WebConn.prototype.destroy=function(){Wire.prototype.destroy.call(this),this._torrent=null};