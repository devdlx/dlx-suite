var finalhandler=require("finalhandler"),fixtures=require("webtorrent-fixtures"),http=require("http"),path=require("path"),series=require("run-series"),serveStatic=require("serve-static"),test=require("tape"),WebTorrent=require("../../");test("Download using webseed (via magnet uri)",function(e){e.plan(9);var n,r,t=serveStatic(path.join(__dirname,"content")),o=http.createServer(function(e,n){var r=finalhandler(e,n);t(e,n,r)});o.on("error",function(n){e.fail(n)}),series([function(e){o.listen(e)},function(r){function t(){o&&a&&r(null)}n=new WebTorrent({dht:!1,tracker:!1}),n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)});var o=!1,a=!1;n.on("torrent",function(n){e.equal(n.name,"Leaves of Grass by Walt Whitman.epub");var r=["Leaves of Grass by Walt Whitman.epub"];e.deepEqual(n.files.map(function(e){return e.name}),r),o=!0,t()});var i=n.add(fixtures.leaves.parsedTorrent);i.on("infoHash",function(){a=!0,t()})},function(t){r=new WebTorrent({dht:!1,tracker:!1}),r.on("error",function(n){e.fail(n)}),r.on("warning",function(n){e.fail(n)});var a="http://localhost:"+o.address().port+"/"+fixtures.leaves.parsedTorrent.name,i=fixtures.leaves.magnetURI+"&ws="+encodeURIComponent(a);r.on("torrent",function(n){function r(){o&&a&&t(null)}n.files.forEach(function(n){n.getBuffer(function(n,t){e.error(n),e.deepEqual(t,fixtures.leaves.content,"downloaded correct content"),o=!0,r()})}),n.once("done",function(){e.pass("client2 downloaded torrent from client1"),a=!0,r()});var o=!1,a=!1});var s=r.add(i);s.on("infoHash",function(){s.addPeer("127.0.0.1:"+n.address().port)})}],function(t){e.error(t),n.destroy(function(n){e.error(n,"client destroyed")}),r.destroy(function(n){e.error(n,"client destroyed")}),o.close(function(){e.pass("http server closed")})})});