var fixtures=require("webtorrent-fixtures"),http=require("http"),test=require("tape"),WebTorrent=require("../../");test("WebTorrent.WEBRTC_SUPPORT",function(e){e.plan(2);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(t){e.fail(t)}),t.on("warning",function(t){e.fail(t)}),e.equal(WebTorrent.WEBRTC_SUPPORT,!1),t.destroy(function(t){e.error(t,"client destroyed")})}),test("client.add: http url to a torrent file, string",function(e){e.plan(8);var t=http.createServer(function(t,r){e.ok(t.headers["user-agent"].indexOf("WebTorrent")!==-1),r.end(fixtures.leaves.torrent)});t.listen(0,function(){var r=t.address().port,n="http://127.0.0.1:"+r,o=new WebTorrent({dht:!1,tracker:!1});o.on("error",function(t){e.fail(t)}),o.on("warning",function(t){e.fail(t)}),o.add(n,function(r){e.equal(o.torrents.length,1),e.equal(r.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(r.magnetURI,fixtures.leaves.magnetURI),o.remove(r,function(t){e.error(t,"torrent destroyed")}),e.equal(o.torrents.length,0),t.close(function(){e.pass("http server closed")}),o.destroy(function(t){e.error(t,"client destroyed")})})})}),test("client.add: filesystem path to a torrent file, string",function(e){e.plan(6);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(t){e.fail(t)}),t.on("warning",function(t){e.fail(t)}),t.add(fixtures.leaves.torrentPath,function(r){e.equal(t.torrents.length,1),e.equal(r.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(r.magnetURI,fixtures.leaves.magnetURI),t.remove(r,function(t){e.error(t,"torrent destroyed")}),e.equal(t.torrents.length,0),t.destroy(function(t){e.error(t,"client destroyed")})})}),test("client.seed: filesystem path to file, string",function(e){e.plan(6);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(t){e.fail(t)}),t.on("warning",function(t){e.fail(t)}),t.seed(fixtures.leaves.contentPath,{name:"Leaves of Grass by Walt Whitman.epub"},function(r){e.equal(t.torrents.length,1),e.equal(r.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(r.magnetURI,fixtures.leaves.magnetURI),t.remove(r,function(t){e.error(t,"torrent destroyed")}),e.equal(t.torrents.length,0),t.destroy(function(t){e.error(t,"client destroyed")})})}),test("client.seed: filesystem path to folder with one file, string",function(e){e.plan(6);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(t){e.fail(t)}),t.on("warning",function(t){e.fail(t)}),t.seed(fixtures.folder.contentPath,function(r){e.equal(t.torrents.length,1),e.equal(r.infoHash,fixtures.folder.parsedTorrent.infoHash),e.equal(r.magnetURI,fixtures.folder.magnetURI),t.remove(r,function(t){e.error(t,"torrent destroyed")}),e.equal(t.torrents.length,0),t.destroy(function(t){e.error(t,"client destroyed")})})}),test("client.seed: filesystem path to folder with multiple files, string",function(e){e.plan(6);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(t){e.fail(t)}),t.on("warning",function(t){e.fail(t)}),t.seed(fixtures.numbers.contentPath,function(r){e.equal(t.torrents.length,1),e.equal(r.infoHash,fixtures.numbers.parsedTorrent.infoHash),e.equal(r.magnetURI,fixtures.numbers.magnetURI),t.remove(r,function(t){e.error(t,"torrent destroyed")}),e.equal(t.torrents.length,0),t.destroy(function(t){e.error(t,"client destroyed")})})}),test("client.add: invalid torrent id: invalid filesystem path",function(e){e.plan(3);var t=new WebTorrent({dht:!1,tracker:!1});t.on("error",function(r){e.ok(r instanceof Error),e.ok(r.message.indexOf("Invalid torrent identifier")>=0),t.destroy(function(t){e.error(t,"client destroyed")})}),t.on("warning",function(t){e.fail(t)}),t.add("/invalid/filesystem/path/123")});