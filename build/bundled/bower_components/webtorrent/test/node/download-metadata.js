function createServer(e,n){var t=http.createServer(function(n,t){"/"!==n.url?(t.statusCode=404,t.end()):t.end(e)});t.on("listening",function(){var e=t.address(),r="http://127.0.0.1:"+e.port+"/";n(r,t)}),t.listen()}var fixtures=require("webtorrent-fixtures"),http=require("http"),test=require("tape"),WebTorrent=require("../../");test("Download metadata for magnet URI with xs parameter",function(e){e.plan(3);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),createServer(fixtures.leaves.torrent,function(t,r){var o=encodeURIComponent(t);n.add(fixtures.leaves.magnetURI+"&xs="+o,function(t){e.equal(t.files[0].name,"Leaves of Grass by Walt Whitman.epub"),n.destroy(function(n){e.error(n,"client destroyed")}),r.close(function(){e.pass("server closed")})})})}),test("Download metadata for magnet URI with 2 xs parameters",function(e){e.plan(4);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),createServer(fixtures.leaves.torrent,function(t,r){var o=encodeURIComponent(t);createServer(fixtures.leaves.torrent,function(t,a){var s=encodeURIComponent(t),i=fixtures.leaves.magnetURI+"&xs="+o+"&xs="+s;n.add(i,function(t){e.equal(t.files[0].name,"Leaves of Grass by Walt Whitman.epub"),n.destroy(function(n){e.error(n,"client destroyed")}),r.close(function(){e.pass("server closed")}),a.close(function(){e.pass("server closed")})})})})}),test("Download metadata for magnet URI with 2 xs parameters, with 1 invalid protocol",function(e){e.plan(3);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),createServer(fixtures.leaves.torrent,function(t,r){var o=encodeURIComponent("invalidurl:example"),a=encodeURIComponent(t),s=fixtures.leaves.magnetURI+"&xs="+o+"&xs="+a;n.add(s,function(t){e.equal(t.files[0].name,"Leaves of Grass by Walt Whitman.epub"),n.destroy(function(n){e.error(n,"client destroyed")}),r.close(function(){e.pass("server closed")})})})}),test("Download metadata for magnet URI with 2 xs parameters, with 1 404 URL",function(e){e.plan(3);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),createServer(fixtures.leaves.torrent,function(t,r){var o=encodeURIComponent(t+"blah_404"),a=encodeURIComponent(t),s=fixtures.leaves.magnetURI+"&xs="+o+"&xs="+a;n.add(s,function(t){e.equal(t.files[0].name,"Leaves of Grass by Walt Whitman.epub"),n.destroy(function(n){e.error(n,"client destroyed")}),r.close(function(){e.pass("server closed")})})})}),test("Download metadata magnet URI with unsupported protocol in xs parameter",function(e){e.plan(1);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.add(fixtures.leaves.magnetURI+"&xs="+encodeURIComponent("invalidurl:example")),setTimeout(function(){n.destroy(function(n){e.error(n,"client destroyed")})},100)});