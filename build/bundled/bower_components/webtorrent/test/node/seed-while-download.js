var DHT=require("bittorrent-dht/server"),fixtures=require("webtorrent-fixtures"),fs=require("fs"),series=require("run-series"),test=require("tape"),WebTorrent=require("../../");test("Seed and download a file at the same time",function(e){e.plan(14);var n=new DHT({bootstrap:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)});var t,r;series([function(e){n.listen(e)},function(r){function o(){a&&c&&r(null)}t=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+n.address().port}}),t.on("error",function(n){e.fail(n)}),t.on("warning",function(n){e.fail(n)});var i=t.add(fixtures.leaves.torrent);i.on("dhtAnnounce",function(){e.pass("client1 finished dht announce"),a=!0,o()}),i.load(fs.createReadStream(fixtures.leaves.contentPath),function(n){e.error(n,"client1 started seeding"),c=!0,o()});var a=!1,c=!1},function(o){function i(){c&&d&&o(null)}r=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+n.address().port},torrentPort:t.torrentPort+1}),r.on("error",function(n){e.fail(n)}),r.on("warning",function(n){e.fail(n)});var a=r.add(fixtures.alice.torrent);a.on("dhtAnnounce",function(){e.pass("client2 finished dht announce"),c=!0,i()}),a.load(fs.createReadStream(fixtures.alice.contentPath),function(n){e.error(n,"client2 started seeding"),d=!0,i()});var c=!1,d=!1},function(n){function o(){i&&a&&c&&d&&n(null)}t.add(fixtures.alice.magnetURI),t.on("torrent",function(n){n.files[0].getBuffer(function(n,t){e.error(n),e.deepEqual(t,fixtures.alice.content,"client1 downloaded correct content"),i=!0,o()}),n.once("done",function(){e.pass("client1 downloaded torrent from client2"),c=!0,o()})}),r.add(fixtures.leaves.magnetURI),r.on("torrent",function(n){n.files[0].getBuffer(function(n,t){e.error(n),e.deepEqual(t,fixtures.leaves.content,"client2 downloaded correct content"),a=!0,o()}),n.once("done",function(){e.pass("client2 downloaded torrent from client1"),d=!0,o()})});var i=!1,a=!1,c=!1,d=!1}],function(o){e.error(o),t.destroy(function(n){e.error(n,"client1 destroyed")}),r.destroy(function(n){e.error(n,"client2 destroyed")}),n.destroy(function(n){e.error(n,"dht server destroyed")})})});