var DHT=require("bittorrent-dht/server"),fixtures=require("webtorrent-fixtures"),fs=require("fs"),networkAddress=require("network-address"),series=require("run-series"),test=require("tape"),WebTorrent=require("../../");test("Download using DHT (via magnet uri)",function(e){e.plan(12);var r=new DHT({bootstrap:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n,t;series([function(e){r.listen(e)},function(t){function o(){s&&a&&t(null)}n=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+r.address().port,host:networkAddress.ipv4()}}),n.dht.on("listening",function(){e.equal(n.dhtPort,n.dht.address().port)}),n.on("error",function(r){e.fail(r)}),n.on("warning",function(r){e.fail(r)});var i=n.add(fixtures.leaves.parsedTorrent);i.on("dhtAnnounce",function(){e.pass("finished dht announce"),s=!0,o()}),i.on("ready",function(){e.equal(i.name,"Leaves of Grass by Walt Whitman.epub");var r=["Leaves of Grass by Walt Whitman.epub"];e.deepEqual(i.files.map(function(e){return e.name}),r)}),i.load(fs.createReadStream(fixtures.leaves.contentPath),function(r){e.error(r),a=!0,o()});var s=!1,a=!1},function(n){function o(){i&&s&&n(null)}t=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+r.address().port,host:networkAddress.ipv4()}}),t.on("error",function(r){e.fail(r)}),t.on("warning",function(r){e.fail(r)}),t.on("torrent",function(r){r.files[0].getBuffer(function(r,n){e.error(r),e.deepEqual(n,fixtures.leaves.content,"downloaded correct content"),i=!0,o()}),r.once("done",function(){e.pass("client2 downloaded torrent from client1"),s=!0,o()})}),t.add(fixtures.leaves.magnetURI);var i=!1,s=!1}],function(o){e.error(o),n.destroy(function(r){e.error(r,"client1 destroyed")}),t.destroy(function(r){e.error(r,"client2 destroyed")}),r.destroy(function(r){e.error(r,"dht server destroyed")})})});