var extend=require("xtend"),fixtures=require("webtorrent-fixtures"),hat=require("hat"),test=require("tape"),Torrent=require("../lib/torrent"),Wire=require("bittorrent-protocol");test("Rarity map usage",function(e){e.plan(16);var r=4,t=extend(fixtures.numbers.parsedTorrent,{pieces:Array(r)}),i={listening:!0,peerId:hat(160),torrentPort:6889,dht:!1,tracker:!1,_remove:function(){}},a={},n=new Torrent(t,i,a);n.on("metadata",function(){function t(){var t=s.getRarestPiece();e.ok(t>=0&&t<r),t=s.getRarestPiece(),e.ok(t>=0&&t<r),t=s.getRarestPiece(),e.ok(t>=0&&t<r),t=s.getRarestPiece(),e.ok(t>=0&&t<r)}function i(e,r){e.peerPieces.set(r),e.emit("have",r)}function a(){var e=new Wire;e.peerPieces.set(1),e.peerPieces.set(2),n._onWire(e)}function c(e){var r=n.wires.splice(e,1)[0];r.destroy()}n._onWire(new Wire),n._onWire(new Wire);var s=n._rarityMap;t(),s.recalculate(),t(),i(n.wires[0],0),i(n.wires[1],0),i(n.wires[0],1),i(n.wires[1],3);var o=s.getRarestPiece();e.equal(o,2),s.recalculate(),o=s.getRarestPiece(),e.equal(o,2),a(),a(),o=s.getRarestPiece(),e.equal(o,3),s.recalculate(),o=s.getRarestPiece(),e.equal(o,3),c(3),c(1),o=s.getRarestPiece(),e.equal(o,3),s.recalculate(),o=s.getRarestPiece(),e.equal(o,3),o=s.getRarestPiece(function(e){return e<=1}),e.equal(o,0),o=s.getRarestPiece(function(e){return 1===e||2===e}),e.equal(o,2)}),e.on("end",function(){n.wires.forEach(function(e){e.destroy()}),n.destroy()})});