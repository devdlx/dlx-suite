function torrentDownloadTest(e,n){e.plan(9);var r=0,t=extend(fixtures.leaves.parsedTorrent),o=new TrackerServer("udp"===n?{http:!1,ws:!1}:{udp:!1,ws:!1});o.on("error",function(n){e.fail(n)}),o.on("warning",function(n){e.fail(n)}),o.on("start",function(){r+=1});var a,i;series([function(e){o.listen(e)},function(r){a=new WebTorrent({dht:!1}),a.on("error",function(n){e.fail(n)}),a.on("warning",function(n){e.fail(n)});var i=o[n].address().port,u="http"===n?"http://127.0.0.1:"+i+"/announce":"udp://127.0.0.1:"+i;t.announce=[u],a.on("torrent",function(n){e.equal(n.name,"Leaves of Grass by Walt Whitman.epub");var t=["Leaves of Grass by Walt Whitman.epub"];e.deepEqual(n.files.map(function(e){return e.name}),t),n.load(fs.createReadStream(fixtures.leaves.contentPath),r)}),a.add(t)},function(n){i=new WebTorrent({dht:!1}),i.on("error",function(n){e.fail(n)}),i.on("warning",function(n){e.fail(n)}),i.add(t),i.on("torrent",function(r){function t(){o&&a&&n(null)}r.files.forEach(function(n){n.getBuffer(function(n,r){if(n)throw n;e.deepEqual(r,fixtures.leaves.content,"downloaded correct content"),o=!0,t()})}),r.once("done",function(){e.pass("client2 downloaded torrent from client1"),a=!0,t()});var o=!1,a=!1})}],function(n){e.error(n),e.equal(r,2),o.close(function(){e.pass("tracker closed")}),a.destroy(function(n){e.error(n,"client1 destroyed")}),i.destroy(function(n){e.error(n,"client2 destroyed")})})}var extend=require("xtend"),fixtures=require("webtorrent-fixtures"),fs=require("fs"),series=require("run-series"),test=require("tape"),TrackerServer=require("bittorrent-tracker/server"),WebTorrent=require("../../");test("Download using UDP tracker (via .torrent file)",function(e){torrentDownloadTest(e,"udp")}),test("Download using HTTP tracker (via .torrent file)",function(e){torrentDownloadTest(e,"http")});