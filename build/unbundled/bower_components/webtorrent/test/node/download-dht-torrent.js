var DHT=require("bittorrent-dht/server"),fixtures=require("webtorrent-fixtures"),fs=require("fs"),series=require("run-series"),test=require("tape"),WebTorrent=require("../../");test("Download using DHT (via .torrent file)",function(e){e.plan(10);var n=new DHT({bootstrap:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)});var r,t;series([function(e){n.listen(e)},function(t){function o(e){(a&&s&&u||e)&&t(e,r)}r=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+n.address().port}}),r.dht.on("listening",function(){e.equal(r.dhtPort,r.dht.address().port)}),r.on("error",function(n){e.fail(n)}),r.on("warning",function(n){e.fail(n)});var i=r.add(fixtures.leaves.parsedTorrent);i.on("ready",function(){e.equal(i.name,"Leaves of Grass by Walt Whitman.epub");var n=["Leaves of Grass by Walt Whitman.epub"];e.deepEqual(i.files.map(function(e){return e.name}),n)}),i.load(fs.createReadStream(fixtures.leaves.contentPath),function(e){s=!0,o(e)}),i.on("dhtAnnounce",function(){a=!0,o(null)}),i.on("noPeers",function(n){e.equal(n,"dht","noPeers event seen with correct announceType"),u=!0,o(null)});var a=!1,s=!1,u=!1},function(r){t=new WebTorrent({tracker:!1,dht:{bootstrap:"127.0.0.1:"+n.address().port}}),t.on("error",function(n){e.fail(n)}),t.on("warning",function(n){e.fail(n)}),t.on("torrent",function(n){function t(){o&&i&&r(null)}n.files.forEach(function(n){n.getBuffer(function(n,r){if(n)throw n;e.deepEqual(r,fixtures.leaves.content,"downloaded correct content"),i=!0,t()})}),n.once("done",function(){e.pass("client2 downloaded torrent from client1"),o=!0,t()});var o=!1,i=!1}),t.add(fixtures.leaves.parsedTorrent)}],function(o){e.error(o),r.destroy(function(n){e.error(n,"client1 destroyed")}),t.destroy(function(n){e.error(n,"client2 destroyed")}),n.destroy(function(n){e.error(n,"dht server destroyed")})})});