function magnetDownloadTest(e,n){e.plan(10);var r=new TrackerServer("udp"===n?{http:!1,ws:!1}:{udp:!1,ws:!1});r.on("error",function(n){e.fail(n)}),r.on("warning",function(n){e.fail(n)});var t=0;r.on("start",function(){t+=1});var o,a,i,u=extend(fixtures.leaves.parsedTorrent);series([function(e){r.listen(e)},function(t){var i=r[n].address().port,s="http"===n?"http://127.0.0.1:"+i+"/announce":"udp://127.0.0.1:"+i;u.announce=[s],o="magnet:?xt=urn:btih:"+u.infoHash+"&tr="+encodeURIComponent(s),a=new WebTorrent({dht:!1}),a.on("error",function(n){e.fail(n)}),a.on("warning",function(n){e.fail(n)}),a.on("torrent",function(n){e.equal(n.name,"Leaves of Grass by Walt Whitman.epub");var r=["Leaves of Grass by Walt Whitman.epub"];n.on("noPeers",function(n){e.equal(n,"tracker","noPeers event seen with correct announceType")}),e.deepEqual(n.files.map(function(e){return e.name}),r),n.load(fs.createReadStream(fixtures.leaves.contentPath),function(e){t(e)})}),a.add(u)},function(n){i=new WebTorrent({dht:!1}),i.on("error",function(n){e.fail(n)}),i.on("warning",function(n){e.fail(n)}),i.on("torrent",function(r){function t(){o&&a&&n(null)}r.files.forEach(function(n){n.getBuffer(function(n,r){if(n)throw n;e.deepEqual(r,fixtures.leaves.content,"downloaded correct content"),o=!0,t()})}),r.once("done",function(){e.pass("client2 downloaded torrent from client1"),a=!0,t()});var o=!1,a=!1}),i.add(o)}],function(n){e.error(n),e.equal(t,2),r.close(function(){e.pass("tracker closed")}),a.destroy(function(n){e.error(n,"client1 destroyed")}),i.destroy(function(n){e.error(n,"client2 destroyed")})})}var extend=require("xtend"),fixtures=require("webtorrent-fixtures"),fs=require("fs"),series=require("run-series"),test=require("tape"),TrackerServer=require("bittorrent-tracker/server"),WebTorrent=require("../../");test("Download using UDP tracker (via magnet uri)",function(e){magnetDownloadTest(e,"udp")}),test("Download using HTTP tracker (via magnet uri)",function(e){magnetDownloadTest(e,"http")});