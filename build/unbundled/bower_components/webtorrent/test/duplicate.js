var fixtures=require("webtorrent-fixtures"),test=require("tape"),WebTorrent=require("../");test("client.seed followed by duplicate client.add (sync)",function(e){e.plan(6);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.seed(fixtures.leaves.content,{name:"Leaves of Grass by Walt Whitman.epub",announce:[]},function(t){e.equal(n.torrents.length,1);var r=n.add(t.infoHash);r.once("ready",function(){e.fail("torrent ready is not called")}),r.once("error",function(t){e.ok(t,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(r.destroyed),n.destroy(function(t){e.error(t,"destroyed client"),e.equal(n.torrents.length,0)})})})}),test("client.seed followed by duplicate client.add (async)",function(e){e.plan(6);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.seed(fixtures.leaves.content,{name:"Leaves of Grass by Walt Whitman.epub",announce:[]},function(t){e.equal(n.torrents.length,1);var r=n.add(fixtures.leaves.torrentPath);r.once("ready",function(){e.fail("torrent ready is not called")}),r.once("error",function(t){e.ok(t,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(r.destroyed),n.destroy(function(t){e.error(t,"destroyed client"),e.equal(n.torrents.length,0)})})})}),test("client.seed followed by two duplicate client.add calls (sync)",function(e){e.plan(9);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.seed(fixtures.leaves.content,{name:"Leaves of Grass by Walt Whitman.epub",announce:[]},function(t){e.equal(n.torrents.length,1);var r=n.add(t.infoHash);r.once("ready",function(){e.fail("torrent ready is not called")}),r.once("error",function(o){e.ok(o,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(r.destroyed);var a=n.add(t.infoHash);a.once("ready",function(){e.fail("torrent ready is not called")}),a.once("error",function(t){e.ok(t,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(a.destroyed),n.destroy(function(t){e.error(t,"destroyed client"),e.equal(n.torrents.length,0)})})})})}),test("client.seed followed by two duplicate client.add calls (async)",function(e){e.plan(9);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.seed(fixtures.leaves.content,{name:"Leaves of Grass by Walt Whitman.epub",announce:[]},function(t){e.equal(n.torrents.length,1);var r=n.add(fixtures.leaves.torrentPath);r.once("ready",function(){e.fail("torrent ready is not called")}),r.once("error",function(t){e.ok(t,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(r.destroyed);var o=n.add(fixtures.leaves.torrentPath);o.once("ready",function(){e.fail("torrent ready is not called")}),o.once("error",function(t){e.ok(t,"got expected error on duplicate add"),e.equal(n.torrents.length,1),e.ok(o.destroyed),n.destroy(function(t){e.error(t,"destroyed client"),e.equal(n.torrents.length,0)})})})})}),test("successive sync client.add, client.remove, client.add, client.remove (sync)",function(e){e.plan(3);var n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(n){e.fail(n)}),n.on("warning",function(n){e.fail(n)}),n.seed(fixtures.leaves.content,{name:"Leaves of Grass by Walt Whitman.epub",announce:[]},function(t){e.equal(n.torrents.length,1),n.add(t.infoHash),n.remove(t.infoHash),n.add(t.infoHash),n.remove(t.infoHash,function(){n.destroy(function(t){e.error(t,"destroyed client"),e.equal(n.torrents.length,0)})})})});