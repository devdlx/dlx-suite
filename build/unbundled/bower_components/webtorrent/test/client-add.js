var Buffer=require("safe-buffer").Buffer,extend=require("xtend"),fixtures=require("webtorrent-fixtures"),test=require("tape"),WebTorrent=require("../");test("client.add: magnet uri, utf-8 string",function(e){e.plan(6);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.magnetURI);e.equal(r.torrents.length,1),n.on("infoHash",function(){e.equal(n.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(n.magnetURI,fixtures.leaves.magnetURI),r.remove(fixtures.leaves.magnetURI,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: torrent file, buffer",function(e){e.plan(6);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.torrent);e.equal(r.torrents.length,1),n.on("infoHash",function(){e.equal(n.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(n.magnetURI,fixtures.leaves.magnetURI),r.remove(fixtures.leaves.torrent,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: info hash, hex string",function(e){e.plan(6);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.parsedTorrent.infoHash);e.equal(r.torrents.length,1),n.on("infoHash",function(){e.equal(n.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(n.magnetURI,"magnet:?xt=urn:btih:"+fixtures.leaves.parsedTorrent.infoHash),r.remove(fixtures.leaves.parsedTorrent.infoHash,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: info hash, buffer",function(e){e.plan(6);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.parsedTorrent.infoHashBuffer);e.equal(r.torrents.length,1),n.on("infoHash",function(){e.equal(n.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.ok(0===n.magnetURI.indexOf("magnet:?xt=urn:btih:"+fixtures.leaves.parsedTorrent.infoHash)),r.remove(Buffer.from(fixtures.leaves.parsedTorrent.infoHash,"hex"),function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: parsed torrent, from `parse-torrent`",function(e){e.plan(6);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.parsedTorrent);e.equal(r.torrents.length,1),n.on("infoHash",function(){e.equal(n.infoHash,fixtures.leaves.parsedTorrent.infoHash),e.equal(n.magnetURI,fixtures.leaves.magnetURI),r.remove(fixtures.leaves.parsedTorrent,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: parsed torrent, with string type announce property",function(e){e.plan(7);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=extend(fixtures.leaves.parsedTorrent);n.announce="http://tracker.local:80";var t=r.add(n);e.equal(r.torrents.length,1),t.on("infoHash",function(){e.equal(t.infoHash,fixtures.leaves.parsedTorrent.infoHash);var n=fixtures.leaves.magnetURI+"&tr="+encodeURIComponent("http://tracker.local:80");e.equal(t.magnetURI,n),e.deepEqual(t.announce,["http://tracker.local:80"]),r.remove(fixtures.leaves.parsedTorrent,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: parsed torrent, with array type announce property",function(e){e.plan(7);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=extend(fixtures.leaves.parsedTorrent);n.announce=["http://tracker.local:80","http://tracker.local:81"];var t=r.add(n);e.equal(r.torrents.length,1),t.on("infoHash",function(){e.equal(t.infoHash,fixtures.leaves.parsedTorrent.infoHash);var n=fixtures.leaves.magnetURI+"&tr="+encodeURIComponent("http://tracker.local:80")+"&tr="+encodeURIComponent("http://tracker.local:81");e.equal(t.magnetURI,n),e.deepEqual(t.announce,["http://tracker.local:80","http://tracker.local:81"]),r.remove(fixtures.leaves.parsedTorrent,function(r){e.error(r,"torrent destroyed")}),e.equal(r.torrents.length,0),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: invalid torrent id: empty string",function(e){e.plan(3);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(n){e.ok(n instanceof Error),e.ok(n.message.indexOf("Invalid torrent identifier")>=0),r.destroy(function(r){e.error(r,"client destroyed")})}),r.on("warning",function(r){e.fail(r)}),r.add("")}),test("client.add: invalid torrent id: short buffer",function(e){e.plan(3);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(n){e.ok(n instanceof Error),e.ok(n.message.indexOf("Invalid torrent identifier")>=0),r.destroy(function(r){e.error(r,"client destroyed")})}),r.on("warning",function(r){e.fail(r)}),r.add(Buffer.from("abc"))});