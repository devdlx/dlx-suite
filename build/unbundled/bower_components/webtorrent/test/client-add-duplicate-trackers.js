var extend=require("xtend"),fixtures=require("webtorrent-fixtures"),test=require("tape"),WebTorrent=require("../");test("client.add: duplicate trackers",function(e){e.plan(3);var r=new WebTorrent({dht:!1,tracker:!1});r.on("error",function(r){e.fail(r)}),r.on("warning",function(r){e.fail(r)});var n=r.add(fixtures.leaves.torrent,{announce:["wss://example.com","wss://example.com","wss://example.com"]});n.on("ready",function(){e.equal(n.magnetURI,fixtures.leaves.magnetURI+"&tr="+encodeURIComponent("wss://example.com")),r.remove(fixtures.leaves.magnetURI,function(r){e.error(r,"torrent destroyed")}),r.destroy(function(r){e.error(r,"client destroyed")})})}),test("client.add: duplicate trackers, with multiple torrents",function(e){e.plan(5);var r={announce:["wss://example.com","wss://example.com","wss://example.com"]},n=new WebTorrent({dht:!1,tracker:!1});n.on("error",function(r){e.fail(r)}),n.on("warning",function(r){e.fail(r)});var t=n.add(fixtures.leaves.torrent,r);t.on("ready",function(){e.equal(t.magnetURI,fixtures.leaves.magnetURI+"&tr="+encodeURIComponent("wss://example.com"));var o=n.add(fixtures.alice.torrent,r);o.on("ready",function(){e.equal(o.magnetURI,fixtures.alice.magnetURI+"&tr="+encodeURIComponent("wss://example.com")),t.destroy(function(r){e.error(r,"torrent1 destroyed")}),o.destroy(function(r){e.error(r,"torrent2 destroyed")}),n.destroy(function(r){e.error(r,"client destroyed")})})})}),test("client.add: duplicate trackers (including in .torrent file), multiple torrents",function(e){e.plan(5);var r={announce:["wss://example.com","wss://example.com","wss://example.com"]},n=extend(fixtures.leaves.parsedTorrent);n.announce=["wss://example.com","wss://example.com","wss://example.com"];var t=extend(fixtures.alice.parsedTorrent);t.announce=["wss://example.com","wss://example.com","wss://example.com"];var o=new WebTorrent({dht:!1,tracker:!1});o.on("error",function(r){e.fail(r)}),o.on("warning",function(r){e.fail(r)});var a=o.add(n,r);a.on("ready",function(){e.equal(a.magnetURI,fixtures.leaves.magnetURI+"&tr="+encodeURIComponent("wss://example.com"));var n=o.add(t,r);n.on("ready",function(){e.equal(n.magnetURI,fixtures.alice.magnetURI+"&tr="+encodeURIComponent("wss://example.com")),a.destroy(function(r){e.error(r,"torrent1 destroyed")}),n.destroy(function(r){e.error(r,"torrent2 destroyed")}),o.destroy(function(r){e.error(r,"client destroyed")})})})});