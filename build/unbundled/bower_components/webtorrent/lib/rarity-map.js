function RarityMap(e){var i=this;i._torrent=e,i._numPieces=e.pieces.length,i._pieces=[],i._onWire=function(e){i.recalculate(),i._initWire(e)},i._onWireHave=function(e){i._pieces[e]+=1},i._onWireBitfield=function(){i.recalculate()},i._torrent.wires.forEach(function(e){i._initWire(e)}),i._torrent.on("wire",i._onWire),i.recalculate()}function trueFn(){return!0}module.exports=RarityMap,RarityMap.prototype.getRarestPiece=function(e){e||(e=trueFn);for(var i=[],t=1/0,r=0;r<this._numPieces;++r)if(e(r)){var n=this._pieces[r];n===t?i.push(r):n<t&&(i=[r],t=n)}return i.length>0?i[Math.random()*i.length|0]:-1},RarityMap.prototype.destroy=function(){var e=this;e._torrent.removeListener("wire",e._onWire),e._torrent.wires.forEach(function(i){e._cleanupWireEvents(i)}),e._torrent=null,e._pieces=null,e._onWire=null,e._onWireHave=null,e._onWireBitfield=null},RarityMap.prototype._initWire=function(e){var i=this;e._onClose=function(){i._cleanupWireEvents(e);for(var t=0;t<this._numPieces;++t)i._pieces[t]-=e.peerPieces.get(t)},e.on("have",i._onWireHave),e.on("bitfield",i._onWireBitfield),e.once("close",e._onClose)},RarityMap.prototype.recalculate=function(){var e;for(e=0;e<this._numPieces;++e)this._pieces[e]=0;var i=this._torrent.wires.length;for(e=0;e<i;++e)for(var t=this._torrent.wires[e],r=0;r<this._numPieces;++r)this._pieces[r]+=t.peerPieces.get(r)},RarityMap.prototype._cleanupWireEvents=function(e){e.removeListener("have",this._onWireHave),e.removeListener("bitfield",this._onWireBitfield),e._onClose&&e.removeListener("close",e._onClose),e._onClose=null};